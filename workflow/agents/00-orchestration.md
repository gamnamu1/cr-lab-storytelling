# 멀티에이전트 오케스트레이션 가이드

## 프로젝트 컨텍스트

이 시스템은 **CR(Checking the News Reliability) 프로젝트**의 일부입니다.

### 핵심 목표
언론 문제와 미디어 리터러시에 대한 **공감과 이해**를 이끌어내는 소설 창작.
직접적인 CR 홍보가 아니라, 독자가 스스로 질문을 던지게 하는 것이 목표입니다.

### 창작 원칙
- **프로파간다가 아닌 문학**: 해답을 제시하지 않고, 질문을 던진다
- **구체적 현실의 재현**: 추상적 비판보다 생생한 현장 묘사
- **열린 결말 지향**: 독자가 스스로 생각하게 만드는 여백

### 컨텍스트 자동 주입
- 모든 에이전트는 `project_context.md`를 자동으로 참조합니다
- 언론 도메인 사용 시 `references/cr-knowledge/` 디렉토리의 지식 베이스가 자동 로드됩니다

### 관련 파일
- `workflow/project_context.md`: 프로젝트 핵심 철학
- `workflow/references/cr-knowledge/`: CR 지식 베이스 (언론 도메인용)

---

## 파이프라인 구조

```
[사용자 입력: 소재/주제]
    ↓
[1] 철학자 → 화두/문제의식 도출
    ↓
[2] 소설가 A → 시놉시스 작성
    ↓
[3] 소설가 B → 시놉시스 비평
    ↓
[4] 소설가 A → 피드백 반영 + 본문 초고
    ↓
[5] 편집자 → 편집 의견
    ↓
[6] 소설가 A → 편집 반영
    ↓
[7] 비평가 → 문학적 해석
    ↓
[8] 소설가 A → 비평 반영 + 최종본
```

---

## 에이전트 역할 요약

| 에이전트 | 역할 | 핵심 역량 |
|---------|------|----------|
| **철학자** | 화두/문제의식 도출 | 본질적 질문 추출, 철학적 깊이 부여 |
| **소설가 A** | 시놉시스/본문 작성 | 구조 설계, 캐릭터 창작, 감각적 표현 |
| **소설가 B** | 구조적 비평 | 플롯 분석, 개연성 점검, 건설적 피드백 |
| **편집자** | 문장 다듬기 | 간결성, 리듬, 가독성, 몰입도 강화 |
| **비평가** | 문학적 해석 | 주제의식 분석, 상징 해독, 승화 방향 제시 |

---

## 단계별 인터페이스 정의

| 단계 | 에이전트 | 입력 | 출력 | 다음 단계로 전달할 핵심 |
|------|---------|------|------|----------------------|
| 1 | 철학자 | 사용자 소재 | `theme.md` | 화두, 핵심 질문, 문제의식 |
| 2 | 소설가 A | `theme.md` | `synopsis_v1.md` | 시공간, 인물, 사건 구조 |
| 3 | 소설가 B | `synopsis_v1.md` | `feedback.md` | 구조적 문제점, 개선안 |
| 4 | 소설가 A | `synopsis_v1` + `feedback` | `draft_v1.md` | 본문 초고 |
| 5 | 편집자 | `draft_v1.md` | `edit_notes.md` | 문체/표현 개선점 |
| 6 | 소설가 A | `draft_v1` + `edit_notes` | `draft_v2.md` | 수정된 본문 |
| 7 | 비평가 | `draft_v2.md` | `critique.md` | 문학적 해석, 승화 방향 |
| 8 | 소설가 A | `draft_v2` + `critique` | `final.md` | 최종 완성본 |

---

## 파일 저장 구조

각 스토리별로 다음 구조로 파일을 저장합니다:

```
stories/
├── 01_outlines/
│   └── [story_id]/
│       ├── theme.md           ← Step 1 산출물
│       ├── synopsis_v1.md     ← Step 2 산출물
│       └── feedback.md        ← Step 3 산출물
├── 02_critiques_v1/
│   └── [story_id]/
│       └── feedback.md        ← Step 3 산출물 복사본
├── 03_drafts/
│   └── [story_id]/
│       ├── draft_v1.md        ← Step 4 산출물
│       └── edit_notes.md      ← Step 5 산출물
├── 04_critiques_v2/
│   └── [story_id]/
│       └── critique.md        ← Step 7 산출물
└── 05_final_manuscripts/
    └── [story_id]/
        └── final.md           ← Step 8 산출물
```

---

## 사용자 개입 지점 (체크포인트)

### 체크포인트 1: Step 3 완료 후 (시놉시스 확정 전)
- **표시 내용**: 시놉시스와 소설가 B의 피드백
- **사용자 선택**:
  - "진행해" → Step 4로 이동
  - "수정해줘" + 지시사항 → Step 2 재실행
  - "처음부터" → Step 1 재실행

### 체크포인트 2: Step 5 완료 후 (초고 확정 전)
- **표시 내용**: 본문 초고와 편집자 의견
- **사용자 선택**:
  - "진행해" → Step 6으로 이동
  - "수정해줘" + 지시사항 → Step 4 재실행
  - 추가 지시 수용

### 체크포인트 3: Step 7 완료 후 (최종본 전)
- **표시 내용**: 수정된 본문과 비평가 해석
- **사용자 선택**:
  - "완성해줘" → Step 8로 이동
  - "더 다듬어줘" + 지시사항 → Step 6 재실행

---

## 품질 게이트

각 단계 완료 시 다음을 확인:

### 공통 체크리스트
- [ ] 이전 단계의 핵심 요소가 누락 없이 반영되었는가?
- [ ] 해당 에이전트의 체크리스트를 통과했는가?
- [ ] '좋은 소설'의 5가지 품질 기준 중 해당 영역이 충족되는가?

### 단계별 품질 기준

| 단계 | 품질 기준 |
|------|----------|
| Step 1 | 철학적 깊이 있는 화두가 도출되었는가? |
| Step 2 | 구조가 탄탄하고 캐릭터가 살아있는가? |
| Step 3 | 건설적이고 구체적인 피드백인가? |
| Step 4 | 감각적 묘사와 몰입감이 있는가? |
| Step 5 | 문장이 간결하고 리듬감이 있는가? |
| Step 6 | 편집 의견이 적절히 반영되었는가? |
| Step 7 | 문학적 해석과 승화 방향이 명확한가? |
| Step 8 | 모든 피드백이 통합되어 완성도가 높은가? |

---

## 반복 개선 조건

### 자동 회귀 트리거

| 조건 | 회귀 대상 |
|------|----------|
| 소설가 B가 "구조적 결함" 지적 | Step 2 재실행 |
| 편집자가 "전면 재작성 필요" 판단 | Step 4 재실행 |
| 비평가가 "주제 이탈" 지적 | Step 1부터 재검토 |

### 회귀 시 주의사항
- 이전 버전의 장점은 보존
- 수정 이유를 명확히 기록
- 최대 3회 반복 후 최선의 버전으로 확정

---

## 종료 조건

다음 조건 중 하나를 만족하면 파이프라인 종료:

1. **정상 종료**: 모든 체크리스트 통과 + 사용자 최종 승인
2. **반복 상한 도달**: 3회 반복 후 최선의 버전으로 확정
3. **사용자 중단**: 사용자가 명시적으로 종료 요청

---

## 에이전트 간 커뮤니케이션 프로토콜

### 피드백 형식 표준

```markdown
## [에이전트명] 피드백

### 잘된 점
- [구체적 칭찬 1]
- [구체적 칭찬 2]

### 개선 필요
- [구체적 지적 1]: [개선 방향]
- [구체적 지적 2]: [개선 방향]

### 권고 사항
- [선택적 제안 1]
- [선택적 제안 2]
```

### 인수인계 원칙
1. **명확성**: 다음 에이전트가 즉시 이해할 수 있도록 작성
2. **구체성**: 추상적 지적보다 구체적 예시 포함
3. **건설성**: 문제 지적과 함께 해결 방향 제시
4. **존중**: 이전 에이전트의 작업 의도 존중

---

## 품질 기준 (최종 소설이 지향할 특성)

| 차원 | 특성 | 담당 에이전트 |
|------|------|--------------|
| **문체** | 감각적인 묘사, 생생함, 독특하거나 아름다운 문체 | 소설가 A, 편집자 |
| **구조** | 짜임새, 정교함, 탄탄한 리듬, 완성도 | 소설가 A, 소설가 B |
| **몰입** | 흡입력, 다음 장이 궁금함, 단숨에 읽히는 에너지 | 소설가 A, 편집자 |
| **깊이** | 사안의 이면을 꿰뚫음, 철학적 사유, 묵직한 질문 | 철학자, 비평가 |
| **공감** | 살아있는 캐릭터, 깊이 있고 공감되는 인물 | 소설가 A, 소설가 B |

---

## 비상 프로토콜

### 교착 상태 해결
- 3회 이상 같은 피드백이 반복될 경우, 사용자에게 방향 선택 요청
- 에이전트 간 의견 충돌 시, 철학자의 원래 화두를 기준으로 판단

### 품질 미달 시
- 해당 단계 에이전트의 체크리스트를 하나씩 점검
- 특정 영역이 지속적으로 미달일 경우, 해당 에이전트 지침 강화 검토

---

## 버전 관리

각 산출물에는 버전 정보를 포함:

```markdown
---
story_id: [고유 ID]
version: v1.0
stage: [현재 단계]
agent: [작성 에이전트]
created: [생성일시]
modified: [수정일시]
---
```

---

# 확장 모드

## 모드 A: 도메인 학습 모드 (Domain-Enhanced Mode)

특정 분야의 전문 지식을 학습한 후 소설을 창작합니다.

### 파이프라인

```
[사용자 입력] + [도메인 자료 경로]
        ↓
[0] 리서처 → 도메인 지식 추출 (00-domain_knowledge.md)
        ↓
[1] 철학자 → 화두 도출 (도메인 지식 참조)
        ↓
[2-8] 기존 파이프라인과 동일
```

### 추가 에이전트

| 에이전트 | 역할 | 지침서 |
|---------|------|--------|
| **리서처** | 도메인 자료 분석, 소설 창작용 지식 추출 | `00-researcher.md` |

### 실행 방법
```bash
python run.py --input "소재.txt" --domain "references/journalism/" --interactive
python run.py --input "소재.txt" --domain "references/medicine/" --auto
```

### 도메인 자료 준비

`references/[도메인명]/` 디렉토리에 다음 유형의 자료를 준비:

| 자료 유형 | 설명 | 예시 |
|----------|------|------|
| 입문서/개론 | 해당 분야의 기본 구조와 개념 | `journalism_basics.md` |
| 내부자 수기 | 현장 경험, 에세이, 인터뷰 | `reporter_memoir.md` |
| 사건/사례 | 실제 있었던 일들 | `famous_cases.md` |
| 용어집 | 전문 용어와 은어 | `terminology.md` |
| 윤리/관행 | 업계 규범과 암묵적 규칙 | `ethics_code.md` |

### 산출물 구조
```
outputs/
├── 00-domain_knowledge.md   ← 리서처 산출물 (NEW)
├── 01-theme.md              ← 철학자 (도메인 지식 반영)
├── 02-synopsis_v1.md
└── ... (기존과 동일)
```

---

## 모드 B: 재작성 모드 (Revision Mode)

완성된 소설에 독자 피드백을 반영하여 수정합니다.

### 파이프라인

```
[기존 final.md] + [독자 피드백]
        ↓
[R1] 진단자 → 수정 계획 (R1-revision_plan.md)
        ↓
[R2] 수정 범위에 따라 분기:
     ├─ 표면 수정 → 편집자 → 소설가 A
     ├─ 부분 수정 → 소설가 A
     ├─ 구조 재검토 → 소설가 B → 소설가 A
     └─ 근본 재검토 → 철학자부터 재실행
        ↓
[R3] 편집자 → 수정본 검토
        ↓
[R4] 소설가 A → 최종 반영 (revised_final.md)
```

### 추가 에이전트

| 에이전트 | 역할 | 지침서 |
|---------|------|--------|
| **진단자** | 피드백 분석, 수정 범위/방향 결정 | `00-diagnostician.md` |

### 피드백 유형별 재진입 지점

| 피드백 유형 | 예시 | 수정 범위 | 재진입 지점 |
|------------|------|----------|------------|
| **문체/표현** | "문장이 딱딱해요" | 표면 수정 | 편집자 |
| **장면/에피소드** | "이 장면이 늘어져요" | 부분 수정 | 소설가 A |
| **캐릭터/동기** | "주인공 동기가 약해요" | 구조 재검토 | 소설가 B → A |
| **플롯/구조** | "결말이 억지스러워요" | 구조 재설계 | 소설가 B → A |
| **주제/의미** | "메시지가 안 와닿아요" | 근본 재검토 | 철학자부터 |

### 실행 방법
```bash
# 피드백 직접 입력
python run.py --revise "outputs/08-final.md" --feedback "결말이 너무 급해요"

# 피드백 파일로 입력
python run.py --revise "outputs/08-final.md" --feedback-file "feedback.txt"
```

### 산출물 구조
```
outputs/
├── 08-final.md              ← 기존 완성본
├── R1-revision_plan.md      ← 진단자 산출물 (NEW)
├── R2-draft_revised.md      ← 수정된 본문 (NEW)
├── R3-edit_notes.md         ← 편집자 검토 (NEW)
└── revised_final.md         ← 최종 수정본 (NEW)
```

### 반복 재작성

수정 결과가 여전히 불만족스러우면 다시 재작성 모드 실행:
```bash
python run.py --revise "outputs/revised_final.md" --feedback "추가 피드백"
```

---

## 모드 조합

도메인 학습 + 재작성을 조합할 수 있습니다:

### 권장 워크플로우

```
1. 도메인 학습 모드로 초안 완성
   python run.py --input "소재.txt" --domain "references/journalism/" --auto

2. 검토 후 재작성 모드로 수정
   python run.py --revise "outputs/08-final.md" --feedback "피드백"

3. 필요시 반복
   python run.py --revise "outputs/revised_final.md" --feedback "추가 피드백"
```

### 전체 모드 요약

| 모드 | 용도 | 시작점 | 핵심 에이전트 |
|------|------|--------|--------------|
| **기본** | 일반 소설 창작 | 소재 | 철학자 → ... |
| **도메인 학습** | 전문 분야 소설 | 소재 + 도메인 자료 | 리서처 → 철학자 → ... |
| **재작성** | 피드백 반영 수정 | 완성본 + 피드백 | 진단자 → 해당 에이전트 |

---

## 확장 에이전트 요약

| 에이전트 | 파일 | 역할 | 모드 |
|---------|------|------|------|
| **리서처** | `00-researcher.md` | 도메인 지식 추출 | 도메인 학습 |
| **진단자** | `00-diagnostician.md` | 피드백 분석, 수정 계획 | 재작성 |
