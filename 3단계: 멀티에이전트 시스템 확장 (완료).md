# 3단계: 멀티에이전트 소설 창작 시스템 확장

## 개요

1-2단계 기본 파이프라인 구현 이후, 시스템에 두 가지 확장 기능을 추가했습니다:
1. **도메인 지식 주입**: 특정 분야 전문 지식을 학습한 후 소설 창작
2. **재작성 프로세스**: 완성된 소설에 독자 피드백을 반영하여 수정

---

## 변경 이력

### 3.0 - 도메인 학습 및 재작성 기능 추가 (초안)
- 리서처 에이전트: 외부 자료 분석 방식
- 진단자 에이전트: 피드백 분석 및 수정 계획
- run.py 확장: 도메인 모드, 재작성 모드 추가

### 3.1 - 리서처 에이전트 페르소나 방식으로 전환
- **변경 사유**: LLM의 내재 지식을 더 효과적으로 활용하기 위해
- **핵심 변경**:
  - 외부 자료 필수 → 페르소나 기반 내재 지식 활용 (추가 자료는 선택)
  - 도메인별 베테랑 페르소나 정의 (15-20년 경력)
  - DOMAIN_PERSONAS 딕셔너리에 8개 도메인 사전 등록
- **영향**: 추가 자료 없이도 풍부한 도메인 지식 생성 가능

### 3.2 - 리서처 에이전트 관점 중립성 보강
- **변경 사유**: 내부자 페르소나의 편향 위험 방지
- **핵심 변경**:
  - 핵심 원칙 5, 6번 추가 (관점 중립, 편향 인식)
  - 관점 중립성 원칙 섹션 신설
  - 출력 구조에 "6. 다중 관점 지도" 추가
    - 체제 내부자의 논리
    - 체제 비판자의 논리
    - 중간 지대
    - 외부자/피해자의 시선
  - 금지/권장 표현 예시 제시
- **영향**: 리서처가 특정 입장을 옹호하지 않고 균형 잡힌 재료 제공

---

## 최종 구현 상태

### 추가된 에이전트 (2개)

#### 1. 리서처 에이전트 (00-researcher.md)
**역할**: 도메인 페르소나 기반 전문 지식 제공

**입력**:
- 사용자 소재/아이디어
- 도메인 키워드 (예: "언론/탐사보도")
- (선택) 추가 참고 자료 경로

**출력**: `00-domain_knowledge.md`

**핵심 원칙**:
1. 내부자 시선으로 세계 파악
2. 암묵지(책에 없는 경험적 지식) 우선
3. 백과사전이 아닌 드라마의 재료 제공
4. 클리셰와 실제의 차이 구분
5. **관점 중립** - 특정 입장 옹호/비판 금지
6. **편향 인식** - 내부자 경험의 편향 가능성 명시

**출력 구조**:
1. 이 세계의 실제 작동 방식 (공식 vs 실제)
2. 이 세계의 사람들 (인물 유형 5가지 이상)
3. 드라마의 씨앗들 (딜레마, 갈등, 전환점)
4. 감각적 디테일 (공간, 소리, 시간, 언어)
5. 클리셰 vs 현실
6. **다중 관점 지도** (신규)
   - 체제 내부자의 논리
   - 체제 비판자의 논리
   - 중간 지대
   - 외부자/피해자의 시선

**관점 중립성 원칙**:
- 역할: 지식 제공자 (옹호자/비판자 아님)
- 다중 관점 제시 의무
- 소설가의 선택권 보장
- 자기 편향 인식 및 명시

#### 2. 진단자 에이전트 (00-diagnostician.md)
**역할**: 독자 피드백 분석 및 수정 계획 수립

**입력**:
- 기존 완성본 (`08-final.md`)
- 독자 피드백 (자유 형식)

**출력**: `R1-revision_plan.md`

**피드백 유형 분류**:
| 유형 | 예시 | 수정 범위 | 재진입 지점 |
|------|------|----------|------------|
| 문체/표현 | "문장이 딱딱해요" | 표면 수정 | 편집자 |
| 장면/에피소드 | "전개가 급해요" | 부분 수정 | 소설가 A |
| 캐릭터/동기 | "주인공 동기가 약해요" | 구조 재검토 | 소설가 B → A |
| 플롯/구조 | "결말이 억지스러워요" | 구조 재설계 | 소설가 B → A |
| 주제/의미 | "메시지가 안 와닿아요" | 근본 재검토 | 철학자부터 |

---

## 확장 모드

### 모드 A: 도메인 학습 모드 (페르소나 기반)

**파이프라인**:
```
[사용자 입력] + [도메인 키워드]
        ↓
[0] 리서처 → 페르소나 기반 도메인 지식 추출
        ↓
[1] 철학자 → 화두 도출 (도메인 지식 참조)
        ↓
[2-8] 기존 파이프라인과 동일
```

**실행 방법**:
```bash
# 기본 (추가 자료 없이)
python run.py --input "소재.txt" --domain "언론/탐사보도" --auto

# 추가 자료 포함 (선택적 보강)
python run.py --input "소재.txt" --domain "언론/탐사보도" --domain-refs "references/journalism/" --auto
```

**등록된 페르소나** (run.py의 DOMAIN_PERSONAS):
| 키워드 | 페르소나 | 경력 |
|--------|---------|------|
| 언론/탐사보도 | 탐사보도 기자 | 20년 |
| 언론/방송뉴스 | 방송기자 겸 앵커 | 18년 |
| 의료/응급의학 | 응급의학 전문의 | 15년 |
| 의료/외과 | 외과 전문의 | 20년 |
| 법조/형사변호 | 형사전문 변호사 | 18년 |
| 법조/검찰 | 검사 | 17년 |
| 교육/고등학교 | 고등학교 교사 | 22년 |
| 기업/스타트업 | 창업자 겸 CTO | 12년 |

미등록 도메인은 자동으로 일반 템플릿 적용.

---

### 모드 B: 재작성 모드

**파이프라인**:
```
[기존 final.md] + [독자 피드백]
        ↓
[R1] 진단자 → 수정 계획 (revision_plan.md)
        ↓
[R2] 소설가 A → 수정 계획 반영 (draft_revised.md)
        ↓
[R3] 편집자 → 수정본 검토 (edit_notes.md)
        ↓
[R4] 소설가 A → 최종 반영 (revised_final.md)
```

**실행 방법**:
```bash
# 직접 피드백 입력
python run.py --revise "outputs/08-final.md" --feedback "결말이 급해요" --auto

# 피드백 파일 사용
python run.py --revise "outputs/08-final.md" --feedback-file "feedback.txt" --auto

# 반복 재작성
python run.py --revise "outputs/revised_final.md" --feedback "추가 피드백" --auto
```

---

## 주요 파일 변경 사항

### 신규 파일
1. **workflow/agents/00-researcher.md** - 리서처 에이전트 지침서 (페르소나 기반 + 관점 중립성)
2. **workflow/agents/00-diagnostician.md** - 진단자 에이전트 지침서

### 수정된 파일
1. **workflow/run.py**:
   - ExtendedNovelWorkflow 클래스 추가
   - DOMAIN_PERSONA_TEMPLATE, DOMAIN_PERSONAS 상수 추가 (관점 중립성 원칙 포함)
   - generate_persona_prompt() 메서드
   - run_researcher() 메서드 (페르소나 기반)
   - run_diagnostician() 메서드
   - run_pipeline_with_domain() 메서드
   - run_revision() 메서드
   - argparse: --domain, --domain-refs, --revise, --feedback, --feedback-file 옵션 추가

2. **workflow/agents/00-orchestration.md**:
   - "확장 모드" 섹션 추가 (도메인 학습 모드, 재작성 모드 설명)

---

## 구현 완료 체크리스트

### 에이전트
- [x] 00-researcher.md 생성 (페르소나 기반)
- [x] 00-researcher.md 관점 중립성 보강
- [x] 00-diagnostician.md 생성

### 코드
- [x] run.py에 DOMAIN_PERSONAS 정의 (관점 중립성 포함)
- [x] run.py에 페르소나 기반 리서처 구현
- [x] run.py에 진단자 구현
- [x] run.py에 도메인 모드 파이프라인 구현
- [x] run.py에 재작성 모드 파이프라인 구현
- [x] argparse 확장

### 문서
- [x] 00-orchestration.md 확장
- [x] 이 종합 문서 작성

---

## 사용 예시

### 예시 1: 언론 관련 소설 (도메인 모드)
```bash
echo "내부고발을 결심한 기자의 이야기" > input.txt
python run.py --input input.txt --domain "언론/탐사보도" --auto
```

**결과**:
- `00-domain_knowledge.md`: 언론계 내부자 지식 (다중 관점 포함)
- `01-theme.md`: 화두 도출
- `02-08`: 기존 파이프라인 산출물
- `08-final.md`: 최종 완성본

### 예시 2: 완성본 재작성 (재작성 모드)
```bash
python run.py --revise outputs/08-final.md --feedback "주인공의 내적 갈등이 약해요. 결정 장면에서 더 고민하는 모습이 필요해요." --auto
```

**결과**:
- `R1-revision_plan.md`: 수정 계획
- `R2-draft_revised.md`: 수정된 초안
- `R3-edit_notes.md`: 편집 의견
- `revised_final.md`: 최종 수정본

---

## 기술적 특징

### 1. 페르소나 기반 지식 활용
- LLM의 방대한 사전학습 지식을 페르소나를 통해 끌어냄
- 외부 자료 없이도 풍부한 도메인 지식 생성 가능
- 추가 자료는 선택적 보강 수단

### 2. 관점 중립성
- 리서처가 특정 입장을 옹호하지 않음
- 체제 내부자, 비판자, 중간 지대, 외부자/피해자 시선을 모두 제시
- 소설가가 관점을 선택할 수 있도록 재료만 제공
- 내부자 편향 가능성을 명시적으로 인식

### 3. 모듈화 설계
- 기존 파이프라인 수정 없이 확장 기능 추가
- 각 모드(기본/도메인/재작성) 독립적 실행 가능
- 모드 조합 가능 (도메인 학습 → 재작성)

### 4. 유연한 재작성
- 피드백 유형에 따라 수정 범위 자동 판단
- 최소 수정 원칙 (기존 강점 보존)
- 반복 재작성 지원

---

## 향후 확장 가능성

1. **도메인 페르소나 확장**: DOMAIN_PERSONAS에 새 도메인 추가
2. **재작성 파이프라인 세분화**: 피드백 유형별 맞춤 경로
3. **다중 도메인 융합**: 여러 도메인 지식 동시 활용
4. **도메인 학습 캐싱**: 동일 도메인 재사용 시 리서처 생략

---

## 주요 설계 결정

### 왜 페르소나 방식인가?
- LLM은 이미 방대한 세계 지식을 보유
- 페르소나를 통해 지식을 "끌어내는" 방식이 효과적
- 외부 자료 수집 부담 감소
- 다양한 도메인에 즉시 대응 가능

### 왜 관점 중립성이 중요한가?
- 소설은 특정 입장의 선전물이 아님
- 리서처가 판단하면 소설가의 창작 자유 침해
- 다양한 관점 제시 → 소설가가 선택 → 더 풍부한 이야기
- 내부자 편향 위험 방지 (페르소나의 부작용 최소화)

### 왜 재작성 모드를 분리했나?
- 창작과 수정은 다른 프로세스
- 피드백 분석 전문 에이전트 필요
- 기존 파이프라인을 처음부터 다시 돌리는 비효율 방지

---

## 참고 사항

- 기본 모드는 여전히 작동 (`python run.py --input "소재.txt" --auto`)
- 도메인 모드 사용 시 `--domain` 필수, `--domain-refs` 선택
- 재작성 모드 사용 시 `--revise` 필수, `--feedback` 또는 `--feedback-file` 필수
- 대화형 모드(`--interactive`)와 자동 모드(`--auto`) 모두 지원

---

**작성일**: 2024-12-20
**최종 업데이트**: 3.2 (관점 중립성 보강 완료)
